<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<style>
body{
margin:0;
background:black;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
}

video{
width:80vw;
border-radius:15px;
}
</style>

</head>

<body>

<video id="video" autoplay playsinline></video>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
getFirestore,
doc,
setDoc,
getDoc,
onSnapshot,
collection,
addDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyBVFBqpZLGOE5PN1hnRN4GNp3AHfjcHNxI",
authDomain: "megagift03.firebaseapp.com",
projectId: "megagift03",
storageBucket: "megagift03.firebasestorage.app",
messagingSenderId: "220522611453",
appId: "1:220522611453:web:95284da4a574518d26b494"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const pc = new RTCPeerConnection({
iceServers:[{urls:"stun:stun.l.google.com:19302"}]
});

const video = document.getElementById("video");

// CRITICAL: prepare stream FIRST
const remoteStream = new MediaStream();

video.srcObject = remoteStream;

pc.ontrack = event=>{
event.streams[0].getTracks().forEach(track=>{
remoteStream.addTrack(track);
});
};

const callRef = doc(db,"calls","megagift-room");

const offerCandidates = collection(db,"calls","megagift-room","offerCandidates");
const answerCandidates = collection(db,"calls","megagift-room","answerCandidates");

// send ICE
pc.onicecandidate = e=>{
if(e.candidate){
addDoc(answerCandidates, e.candidate.toJSON());
}
};

// get offer
const callData = await getDoc(callRef);

const offer = callData.data().offer;

await pc.setRemoteDescription(
new RTCSessionDescription(offer)
);

// create answer
const answer = await pc.createAnswer();

await pc.setLocalDescription(answer);

await setDoc(callRef,{
answer:{
type:answer.type,
sdp:answer.sdp
}
},{merge:true});

// receive ICE
onSnapshot(offerCandidates, snapshot=>{
snapshot.docChanges().forEach(change=>{
if(change.type==="added"){

pc.addIceCandidate(
new RTCIceCandidate(change.doc.data())
);

}
});
});

</script>

</body>
</html>
