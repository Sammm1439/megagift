<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>viewer</title>

<style>

body{
margin:0;
background:black;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
}

video{
width:80vw;
border-radius:15px;
}

</style>

</head>
<body>

<video id="remoteVideo" autoplay playsinline></video>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
getFirestore,
doc,
setDoc,
getDoc,
onSnapshot,
collection,
addDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyBVFBqpZLGOE5PN1hnRN4GNp3AHfjcHNxI",
authDomain: "megagift03.firebaseapp.com",
projectId: "megagift03",
storageBucket: "megagift03.firebasestorage.app",
messagingSenderId: "220522611453",
appId: "1:220522611453:web:95284da4a574518d26b494"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const servers = {
iceServers:[
{ urls:"stun:stun.l.google.com:19302"}
]
};

const pc = new RTCPeerConnection(servers);
const remoteVideo = document.getElementById("remoteVideo");

// RECEIVE VIDEO
pc.ontrack = event=>{
remoteVideo.srcObject = event.streams[0];
};

// SEND ICE BACK
pc.onicecandidate = event=>{
if(event.candidate){
addDoc(collection(db,"calls","megagift-room","answerCandidates"),
event.candidate.toJSON());
}
};

// GET OFFER
const callDoc = doc(db,"calls","megagift-room");
const offerCandidates = collection(db,"calls","megagift-room","offerCandidates");

const callData = await getDoc(callDoc);

if(!callData.exists()){
alert("Open page5 first");
}

const offerDescription = callData.data().offer;

await pc.setRemoteDescription(
new RTCSessionDescription(offerDescription)
);

// CREATE ANSWER
const answerDescription = await pc.createAnswer();

await pc.setLocalDescription(answerDescription);

await setDoc(callDoc,{
answer:{
type:answerDescription.type,
sdp:answerDescription.sdp
}
},{merge:true});

// RECEIVE ICE
onSnapshot(offerCandidates, snapshot=>{
snapshot.docChanges().forEach(change=>{
if(change.type==="added"){
pc.addIceCandidate(
new RTCIceCandidate(change.doc.data())
);
}
});
});

</script>

</body>
</html>
